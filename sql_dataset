DECLARE
  Sys STRING DEFAULT 'NPM';

WITH
  HighestReleases AS (
    SELECT
      Name,
      Version,
    FROM (
      SELECT
        Name,
        Version,
        ROW_NUMBER()
          OVER (PARTITION BY
                  Name
                ORDER BY
                  VersionInfo.Ordinal DESC) AS RowNumber
        FROM
          `bigquery-public-data.deps_dev_v1.PackageVersionsLatest`
        WHERE
          System = Sys
          AND VersionInfo.IsRelease)
    WHERE RowNumber = 1),

    TopPackages AS (
        SELECT
          D.Dependency.Name,
          D.Dependency.Version,
          COUNT(*) AS NDependents
        FROM
          `bigquery-public-data.deps_dev_v1.DependenciesLatest` AS D
        JOIN
          HighestReleases AS H
        ON
          D.Dependency.Name = H.Name AND D.Dependency.Version = H.Version
        WHERE
          D.System = Sys
        GROUP BY
          D.Dependency.Name,
          D.Dependency.Version
        ORDER BY
          NDependents DESC
        LIMIT 1000)
    
SELECT 
  P.Name,
  P.Version,
  COUNT(*) AS NDependencies
FROM 
  `bigquery-public-data.deps_dev_v1.DependenciesLatest` AS P
JOIN
  TopPackages AS T
USING
  (Name, Version)
WHERE
  P.System = Sys
GROUP BY
  P.Name,
  P.Version
ORDER BY NDependencies DESC
